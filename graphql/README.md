# Tfchain graphql

[Hydra](https://docs.subsquid.io) is used to index and provide a graphql interface on toip of tfchain.

This is a project generated by `hydra-cli scaffold`. Types are defined  in  `schema.graphql` and the mappings in the `mappings` folder.

## Concept

The substrate events are processed in a multi-step pipeline:

    Tfchain => Hydra Indexer => Indexer GraphQL gateway => Hydra Processor => Database => Query Node GraphQL endpoint

![Bird eye overview](https://gblobscdn.gitbook.com/assets%2F-MdI-MAyz-csivC8mmdb%2Fsync%2Fe587479ff22ad79886861487b2734b6556302d10.png?alt=media)

## Prerequisites

* Node v14x
* Docker

## Bootstrap

```sh
npm ci

# Start postgres instance
docker-compose up db # add optional -d flag to detach from terminal

# Apply pending migrations
npm run db:migrate

# Apply migrations related to processor's state keeping tables
npm run processor:migrate

# Now you can start processing chain data
npm run processor:start

# The above command will block
# Open separate terminal and launch graphql server to query the processed data
npm run query-node:start
```

## If you want start from scratch

```sh
# Delete database migrations and other generated files
rm -r db generated types

# Write down your schema.graphql

# Analyze schema.graphql and generate model/server files
npm run codegen

# If necessary, create the database
npm run db:create

# Analyze database state and create migration to match generated models
npm run db:create-migration

# Review typegen section of manifest.yml

# Generate type definitions for substrate events and extrinsics
npm run typegen
```

## Configuration

Project's configuration is driven by environment variables, defined in `.env`,
and `manifest.yml`. For more details see https://docs.subsquid.io.

## Indexer

Running an indexer is required. The indexer can be found in the [indexer folder](./indexer).

It is recommeded to use already set up indexer if available, as new indexer typically
requires some time to catch up with interesting events.

Have a look at `./indexer/docker-compose.yml` for example of how you can set up a self-hosted version.
